---
# Load data from config.json
- import_playbook: ../vars/data.yml

# Configure sshd daemon
- hosts: creampi
  gather_facts: no
  tags: 'sshd_service'
  become: true
  vars:
    remote_conf_path: "{{ services.sshd.conf.remotePath }}"
    local_conf_path: "{{ services.sshd.conf.localPath }}"
    ssh_conf: "{{ services.sshd.conf.template }}"

  tasks:
  - name: Ensure sshd is installed on {{ hostname }}
    ansible.builtin.apt:
      name: ssh
      state: latest
    register: ssh_is_installed

  - name: Copying configuration template for sshd on {{ hostname }}
    ansible.builtin.template:
      src: "{{ local_conf_path }}/{{ ssh_conf }}"
      dest: "{{ remote_conf_path }}/{{ ssh_conf }}"
      owner: root
      group: root
      mode: '0600'
      validate: /usr/sbin/sshd -t -f %s
      force: true
    notify:
      - Restart sshd conf file changes

  - name: Starting ssh service on {{ hostname }}
    ansible.builtin.service:
      name: ssh
      state: started
      enabled: true

  handlers:
    - name: Restart sshd conf file changes
      ansible.builtin.service:
        name: ssh
        state: restarted